<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MELVERSE — мемы Мелстроя</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');

    :root{
      --pink: #ff00c8;
      --green: #00ff80;
      --bg: #000;
      --card: #111;
      --muted: #aaa;
      --dark-gray: #1a1a1a;
      --medium-gray: #2a2a2a;
    }

    *{box-sizing:border-box}
    body {
      margin: 0;
      font-family: 'Bangers', cursive;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 25%, #2d2d2d 50%, #1a1a1a 75%, #0a0a0a 100%);
      background-attachment: fixed;
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: #fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height: 100vh;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50% }
      50% { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }

    header {
      text-align: center;
      padding: 36px 20px;
      background: linear-gradient(90deg, var(--pink), var(--green));
      box-shadow: 0 0 30px rgba(255,0,200,0.15);
      position: relative;
      z-index: 10;
    }

    h1 { font-size: 3rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    header p { margin: 8px 0 0; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

    .controls { margin-top: 12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }

    .btn {
      background: var(--pink);
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 0.95rem;
      border-radius: 10px;
      cursor: pointer;
      transition: transform .15s ease, background .15s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      font-family: 'Bangers', cursive;
    }
    .btn:hover { transform: translateY(-3px); background: var(--green); }

    .quote {
      text-align: center;
      margin: 22px auto;
      font-size: 1.3rem;
      color: var(--green);
      max-width: 820px;
      background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 0 20px rgba(255,0,200,0.06);
      border: 1px solid rgba(255,255,255,0.03);
      backdrop-filter: blur(10px);
    }

    main { padding: 24px; max-width:1200px; margin: 0 auto; position: relative; z-index: 1; }

    h2 { text-align:center; color: var(--green); margin-top: 18px; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }

    .gallery {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
      gap:16px;
      margin-top: 18px;
    }

    .empty-gallery {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
      font-size: 1.2rem;
    }

    .empty-gallery .icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }

    .meme {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border: 2px solid rgba(255,0,200,0.18);
      border-radius: 14px;
      overflow: hidden;
      transition: transform .18s ease, box-shadow .18s ease;
      display:flex; flex-direction:column; align-items:stretch;
      cursor: pointer;
      position: relative;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    .meme:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0,0,0,0.6); }

    .meme-content {
      width:100%;
      height: 220px;
      object-fit: cover;
      display:block;
      background: linear-gradient(90deg, rgba(255,0,200,0.06), rgba(0,255,128,0.03));
    }

    .meme video.meme-content {
      object-fit: cover;
    }

    .meme .body {
      padding: 12px;
      text-align:center;
    }
    .meme h3 { margin: 8px 0 6px; font-size: 1.05rem; }
    .like-row { display:flex; gap:8px; justify-content:center; align-items:center; margin-top:8px; }

    .like-btn {
      background: transparent;
      border: 2px solid rgba(255,0,200,0.12);
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight:700;
      font-family: 'Bangers', cursive;
      transition: all 0.3s ease;
    }
    .like-btn:hover { background: rgba(255,255,255,0.02); }
    .like-btn.liked {
      background: var(--green);
      color: black;
      border-color: var(--green);
    }
    .like-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .media-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      z-index: 2;
    }

    .video-indicator { color: var(--pink); }
    .audio-indicator { color: var(--green); }

    .add-section {
      text-align:center;
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      padding: 20px;
      margin: 26px auto;
      max-width: 780px;
      border-radius: 12px;
      border: 2px solid rgba(255,0,200,0.12);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .upload-area {
      border: 2px dashed rgba(255,0,200,0.3);
      border-radius: 10px;
      padding: 20px;
      margin: 12px 0;
      background: rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: var(--green);
      background: rgba(0,255,128,0.05);
    }

    .upload-area.dragover {
      border-color: var(--pink);
      background: rgba(255,0,200,0.1);
      transform: scale(1.02);
    }

    input[type="text"], input[type="url"], select, input[type="file"] {
      padding:10px 12px;
      border-radius:10px;
      border: none;
      outline: none;
      margin:8px 6px;
      width: calc(50% - 28px);
      min-width: 160px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-family: inherit;
    }

    input[type="file"] {
      width: 100%;
      background: transparent;
      border: 1px solid rgba(255,0,200,0.3);
    }

    input::placeholder {
      color: rgba(255,255,255,0.6);
    }

    .file-info {
      margin: 8px 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .quality-warning {
      color: var(--pink);
      font-size: 0.8rem;
      margin: 5px 0;
    }

    footer{
      text-align:center;
      padding:20px;
      margin-top:30px;
      border-top: 1px solid rgba(255,0,200,0.08);
      color: var(--muted);
      font-size: 0.9rem;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    }

    /* Модальное окно */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.98);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      max-width: 95%;
      max-height: 95%;
      border-radius: 12px;
      box-shadow: 0 0 50px rgba(255,0,200,0.3);
    }

    .modal img.modal-content {
      object-fit: contain;
    }

    .modal video.modal-content {
      background: #000;
    }

    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--pink);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      font-family: 'Bangers', cursive;
      z-index: 1001;
    }

    .modal-audio-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .audio-btn {
      background: var(--green);
      color: black;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Bangers', cursive;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin: 8px 0;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--pink), var(--green));
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Статистика */
    .stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .stat-item {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      padding: 15px 25px;
      border-radius: 10px;
      border: 1px solid rgba(255,0,200,0.2);
      text-align: center;
      min-width: 120px;
    }

    .stat-number {
      font-size: 1.5rem;
      color: var(--green);
      display: block;
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .comments-section {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      padding: 20px;
      margin: 26px auto;
      max-width: 780px;
      border-radius: 12px;
      border: 2px solid rgba(255,0,200,0.12);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .comments-container {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .empty-comments {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 1.1rem;
    }

    .empty-comments .icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      display: block;
    }

    .comment {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      border-left: 3px solid var(--pink);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .comment-author {
      font-weight: bold;
      color: var(--green);
    }

    .comment-date {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .comment-text {
      margin: 0;
      line-height: 1.4;
    }

    .add-comment {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #commentInput {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: white;
      font-family: inherit;
    }

    #commentInput::placeholder {
      color: rgba(255,255,255,0.6);
    }

    .game-section {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      padding: 25px;
      margin: 26px auto;
      max-width: 780px;
      border-radius: 12px;
      border: 2px solid rgba(0,255,128,0.2);
      box-shadow: 0 8px 25px rgba(0,255,128,0.1);
      text-align: center;
    }

    .game-title {
      color: var(--green);
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(0,255,128,0.3);
    }

    .game-media {
      max-width: 400px;
      max-height: 250px;
      border-radius: 10px;
      margin: 15px auto;
      border: 2px solid var(--pink);
      box-shadow: 0 0 20px rgba(255,0,200,0.2);
    }

    .game-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .game-input {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid rgba(255,0,200,0.3);
      background: rgba(255,255,255,0.1);
      color: white;
      font-family: 'Bangers', cursive;
      font-size: 1.1rem;
      text-align: center;
      margin: 15px 0;
    }

    .game-input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .game-input.correct {
      border-color: var(--green);
      background: rgba(0,255,128,0.1);
    }

    .game-input.wrong {
      border-color: #ff4444;
      background: rgba(255,0,0,0.1);
    }

    .game-hint {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 10px 0;
    }

    .game-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
    }

    .game-stat {
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255,0,200,0.3);
    }

    .game-result {
      margin: 15px 0;
      font-size: 1.2rem;
      min-height: 30px;
    }

    .game-correct {
      color: var(--green);
    }

    .game-wrong {
      color: #ff4444;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @media (max-width:700px){
      input[type="text"], input[type="url"], select { width:100%; }
      .controls { gap:6px; }
      h1 { font-size: 2rem; }
      .meme-content { height: 180px; }
      .stats { gap: 10px; }
      .stat-item { padding: 10px 15px; min-width: 100px; }
      .game-stats { gap: 10px; }
      .game-stat { padding: 8px 15px; }
      .add-comment { flex-direction: column; }
      .game-media { max-width: 300px; max-height: 200px; }
    }
  </style>
</head>
<body>
<header>
  <h1>🔥 MELLMEMS 🔥</h1>
  <p>MELLSTROY.GAME</p>  
  <p>Вселенная мемов Меллстроя</p>
  <div class="controls">
    <button class="btn" id="randomQuoteBtn">🎯 Цитата дня</button>
    <button class="btn" id="randomMemeBtn">🎲 Случайный мем</button>
    <button class="btn" id="statsBtn">📊 Статистика</button>
    <button class="btn" id="gameBtn">🎮 Угадай мем</button>
    <button class="btn" id="clearStorageBtn" title="Сбросить локальные данные">🧹 Сбросить</button>
  </div>
</header>

<div class="quote" id="quoteBox">"Я не токсик — я контент!"</div>

<main>
  <div class="stats" id="statsSection" style="display: none;">
    <div class="stat-item">
      <span class="stat-number" id="totalMemes">0</span>
      <div class="stat-label">Всего мемов</div>
    </div>
    <div class="stat-item">
      <span class="stat-number" id="totalLikes">0</span>
      <div class="stat-label">Всего лайков</div>
    </div>
    <div class="stat-item">
      <span class="stat-number" id="topMemeLikes">0</span>
      <div class="stat-label">Рекорд лайков</div>
    </div>
  </div>

  <!-- Мини-игра -->
  <section class="game-section" id="gameSection" style="display: none;">
    <h2 class="game-title">🎮 УГАДАЙ НАЗВАНИЕ МЕМА</h2>
    <div class="game-stats">
      <div class="game-stat">Очки: <span id="gameScore">0</span></div>
      <div class="game-stat">Рекорд: <span id="gameHighScore">0</span></div>
      <div class="game-stat">Верно: <span id="gameCorrect">0</span>/<span id="gameTotal">0</span></div>
    </div>

    <div id="gameMediaContainer">
    </div>

    <input type="text" id="gameInput" class="game-input" placeholder="Введите название мема..." />
    <div class="game-hint">Напиши точное название мема и нажми Enter</div>

    <div class="game-result" id="gameResult"></div>

    <button class="btn" id="checkAnswerBtn">✅ Проверить</button>
    <button class="btn" id="nextGameBtn" style="display: none;">➡️ Следующий мем</button>
    <button class="btn" id="startGameBtn">🎯 Начать игру</button>
  </section>

  <div class="gallery" id="gallery">
    <div class="empty-gallery">
      <span class="icon">🔄</span>
      <div>Пока нет мемов</div>
      <div style="font-size: 0.9rem; margin-top: 8px; opacity: 0.7;">Добавь первый мем через форму ниже!</div>
    </div>
  </div>

  <section class="comments-section" id="commentsSection" style="display: none;">
    <h2>💬 Комментарии к мему: <span id="currentMemeTitle"></span></h2>
    <div class="comments-container" id="commentsContainer">
      <div class="empty-comments">
        <span class="icon">💭</span>
        <div>Пока нет комментариев</div>
        <div style="font-size: 0.9rem; margin-top: 8px; opacity: 0.7;">Оставь первый комментарий!</div>
      </div>
    </div>
    <div class="add-comment">
      <input type="text" id="commentInput" placeholder="Напиши комментарий..." maxlength="200" />
      <button class="btn" id="addCommentBtn">💬 Отправить</button>
    </div>
  </section>

  <section class="add-section" aria-label="Добавить мем">
    <h2>🚀 Добавь свой мем</h2>

    <div class="upload-area" id="uploadArea">
      <div>📁 ПЕРЕТАЩИ ФАЙЛЫ СЮДА ИЛИ</div>
      <div style="margin-top: 8px;">
        <input type="file" id="fileInput" accept="image/*,video/*,audio/*" multiple />
      </div>
      <div class="file-info" id="fileInfo">Можно загружать картинки, видео и аудио</div>
      <div class="quality-warning">✅ Качество сохраняется оригинальное!</div>
      <div class="progress-bar" id="progressBar" style="display: none;">
        <div class="progress" id="progress"></div>
      </div>
    </div>

    <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:12px;">
      <input type="text" id="memeTitle" placeholder="Название мема" />
      <select id="memeType">
        <option value="image">🖼️ Картинка + звук</option>
        <option value="video">🎥 Видео</option>
      </select>
    </div>
    <div style="margin-top:12px;">
      <button class="btn" id="addMemeBtn">Добавить мем</button>
    </div>
  </section>
</main>

<div class="modal" id="mediaModal">
  <button class="close-modal" id="closeModal">✕</button>
  <img id="modalImage" class="modal-content" style="display: none;" />
  <video id="modalVideo" class="modal-content" controls style="display: none;"></video>
  <div class="modal-audio-controls" id="audioControls" style="display: none;">
    <button class="audio-btn" id="playAudioBtn">🔊 Воспроизвести звук</button>
  </div>
</div>

<footer>© 2025 Melverse. Только мемы, без хейта ❤️</footer>

<script>
  const DEFAULT_QUOTES = [
    "Я не токсик — я контент!",
    "Главное — не проигрывать, а развлекать!",
    "Если не трэш, то не стрим.",
    "Контент делается болью и мемами.",
    "Пока другие отдыхают — я контентю!",
    "Это не хейт, это контент!",
    "Я не играю в игры, я делаю шоу!",
    "Трэш и угар — наше всё!"
    "Настоящую любовь ты не купишь за бабки. Никогда в жизни"
    "[Нельзя купить] здоровье. Но его можно улучшить за деньги"
    "Нет, на этого не стоит, но хайп того стоит"
    "Drake за миллион баксов подписался на меня"
    "Я уже красный, культурно не получится на*уй"
    "АМ АМ АМ АМ"
    "Что за бизнес, с*ка?"
    "Шо ты лысый, плаки-плаки, нормалдаки"
    "не жалейте в этой жизни ни о чём и никогда"
    "Человек который не боится одиночества и которому интересно с самим собой, это сильный человек"
  ];

  const DEFAULT_MEMES = [];

  const LS_MEMES = 'melverse_memes_v5';
  const LS_QUOTES = 'melverse_quotes_v1';
  const LS_COMMENTS = 'melverse_comments_v1';
  const LS_GAME_STATS = 'melverse_game_stats_v1';
  const LS_LIKED_MEMES = 'melverse_liked_memes_v1';
  const DB_NAME = 'MelverseDB';
  const DB_VERSION = 1;
  const STORE_NAME = 'media';

  const gallery = document.getElementById('gallery');
  const quoteBox = document.getElementById('quoteBox');
  const randomQuoteBtn = document.getElementById('randomQuoteBtn');
  const randomMemeBtn = document.getElementById('randomMemeBtn');
  const statsBtn = document.getElementById('statsBtn');
  const gameBtn = document.getElementById('gameBtn');
  const addMemeBtn = document.getElementById('addMemeBtn');
  const clearStorageBtn = document.getElementById('clearStorageBtn');
  const mediaModal = document.getElementById('mediaModal');
  const modalImage = document.getElementById('modalImage');
  const modalVideo = document.getElementById('modalVideo');
  const closeModal = document.getElementById('closeModal');
  const fileInput = document.getElementById('fileInput');
  const uploadArea = document.getElementById('uploadArea');
  const fileInfo = document.getElementById('fileInfo');
  const progressBar = document.getElementById('progressBar');
  const progress = document.getElementById('progress');
  const statsSection = document.getElementById('statsSection');
  const playAudioBtn = document.getElementById('playAudioBtn');
  const audioControls = document.getElementById('audioControls');

  const commentsSection = document.getElementById('commentsSection');
  const commentsContainer = document.getElementById('commentsContainer');
  const commentInput = document.getElementById('commentInput');
  const addCommentBtn = document.getElementById('addCommentBtn');
  const currentMemeTitle = document.getElementById('currentMemeTitle');
  const gameSection = document.getElementById('gameSection');
  const gameMediaContainer = document.getElementById('gameMediaContainer');
  const gameInput = document.getElementById('gameInput');
  const gameResult = document.getElementById('gameResult');
  const gameScore = document.getElementById('gameScore');
  const gameHighScore = document.getElementById('gameHighScore');
  const gameCorrect = document.getElementById('gameCorrect');
  const gameTotal = document.getElementById('gameTotal');
  const startGameBtn = document.getElementById('startGameBtn');
  const nextGameBtn = document.getElementById('nextGameBtn');
  const checkAnswerBtn = document.getElementById('checkAnswerBtn');

  let uploadedMedia = null;
  let uploadedAudio = null;
  let currentAudio = null;
  let db = null;
  let memes = [];
  let quotes = [];
  let comments = {};
  let likedMemes = {};
  let currentMemeForComments = null;

  let gameStats = {
    score: 0,
    highScore: 0,
    correct: 0,
    total: 0
  };
  let currentGameMeme = null;
  let gameActive = false;

  function initDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        db = request.result;
        resolve(db);
      };

      request.onupgradeneeded = (event) => {
        const database = event.target.result;
        if (!database.objectStoreNames.contains(STORE_NAME)) {
          const store = database.createObjectStore(STORE_NAME, { keyPath: 'id' });
          store.createIndex('memeId', 'memeId', { unique: false });
        }
      };
    });
  }

  async function saveFileToDB(memeId, file, type) {
    return new Promise((resolve, reject) => {
      if (!db) {
        reject(new Error('Database not initialized'));
        return;
      }

      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);

      const fileData = {
        id: `${memeId}_${type}`,
        memeId: memeId,
        type: type,
        file: file,
        timestamp: Date.now()
      };

      const request = store.put(fileData);

      request.onsuccess = () => resolve(fileData.id);
      request.onerror = () => reject(request.error);
    });
  }

  async function getFileFromDB(fileId) {
    return new Promise((resolve, reject) => {
      if (!db) {
        reject(new Error('Database not initialized'));
        return;
      }

      const transaction = db.transaction([STORE_NAME], 'readonly');
      const store = transaction.objectStore(STORE_NAME);
      const request = store.get(fileId);

      request.onsuccess = () => {
        if (request.result) {
          resolve(request.result.file);
        } else {
          reject(new Error('File not found'));
        }
      };
      request.onerror = () => reject(request.error);
    });
  }

  function createBlobURL(file) {
    return URL.createObjectURL(file);
  }

  function revokeBlobURL(url) {
    if (url && url.startsWith('blob:')) {
      URL.revokeObjectURL(url);
    }
  }

  function saveToStorage(key, value){
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      console.warn('Не удалось сохранить в localStorage', e);
    }
  }

  function loadFromStorage(key){
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : null;
    } catch (e) {
      console.warn('Не удалось прочитать localStorage', e);
      return null;
    }
  }


  function updateStats() {
    const totalMemes = memes.length;
    const totalLikes = memes.reduce((sum, meme) => sum + (meme.likes || 0), 0);
    const topMemeLikes = memes.length > 0 ? Math.max(...memes.map(m => m.likes || 0)) : 0;

    document.getElementById('totalMemes').textContent = totalMemes;
    document.getElementById('totalLikes').textContent = totalLikes;
    document.getElementById('topMemeLikes').textContent = topMemeLikes;
  }

  function toggleStats() {
    const isVisible = statsSection.style.display !== 'none';
    statsSection.style.display = isVisible ? 'none' : 'flex';
    updateStats();
  }

  async function openMediaModal(meme) {
    modalImage.style.display = 'none';
    modalVideo.style.display = 'none';
    audioControls.style.display = 'none';

    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }

    try {
      if (meme.type === 'video') {
        const videoFile = await getFileFromDB(`${meme.id}_media`);
        const videoURL = createBlobURL(videoFile);
        modalVideo.src = videoURL;
        modalVideo.style.display = 'block';
      } else {
        const imageFile = await getFileFromDB(`${meme.id}_media`);
        const imageURL = createBlobURL(imageFile);
        modalImage.src = imageURL;
        modalImage.style.display = 'block';

        if (meme.audioId) {
          audioControls.style.display = 'flex';
          playAudioBtn.onclick = async () => {
            const audioFile = await getFileFromDB(meme.audioId);
            playAudio(audioFile);
          };
        }
      }

      mediaModal.style.display = 'flex';
    } catch (error) {
      console.error('Error opening media:', error);
      alert('Ошибка при загрузке медиа');
    }
  }

  // Обработка загрузки файлов
  function handleFileSelect(files) {
    uploadedMedia = null;
    uploadedAudio = null;

    const mediaFiles = [];
    const audioFiles = [];

    Array.from(files).forEach(file => {
      if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
        mediaFiles.push(file);
      } else if (file.type.startsWith('audio/')) {
        audioFiles.push(file);
      }
    });

    if (mediaFiles.length > 0) {
      uploadedMedia = mediaFiles[0];
      fileInfo.textContent = `📁 Медиа: ${uploadedMedia.name} (${formatFileSize(uploadedMedia.size)})`;

      if (mediaFiles.length > 1 && mediaFiles[1].type.startsWith('audio/')) {
        uploadedAudio = mediaFiles[1];
        fileInfo.textContent += ` | 🔊 Аудио: ${uploadedAudio.name}`;
      }
    }

    if (audioFiles.length > 0 && !uploadedAudio) {
      uploadedAudio = audioFiles[0];
      fileInfo.textContent += ` | 🔊 Аудио: ${uploadedAudio.name}`;
    }

    if (files.length === 0) {
      fileInfo.textContent = 'Можно загружать картинки, видео и аудио';
    }
  }


  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    handleFileSelect(files);
  });

  fileInput.addEventListener('change', (e) => {
    handleFileSelect(e.target.files);
  });

  function playAudio(audioFile) {
    if (!audioFile) return;

    if (currentAudio) {
      currentAudio.pause();
    }

    const audioURL = createBlobURL(audioFile);
    currentAudio = new Audio(audioURL);
    currentAudio.play().catch(e => {
      console.log('Не удалось воспроизвести звук:', e);
    });
  }

  async function renderMemes(){
    gallery.innerHTML = '';

    if (memes.length === 0) {
      gallery.innerHTML = `
        <div class="empty-gallery">
          <span class="icon">🔄</span>
          <div>Пока нет мемов</div>
          <div style="font-size: 0.9rem; margin-top: 8px; opacity: 0.7;">Добавь первый мем через форму ниже!</div>
        </div>
      `;
      return;
    }

    const sorted = memes.slice().sort((a,b) => (b.likes || 0) - (a.likes || 0));

    for (const meme of sorted) {
      const card = document.createElement('article');
      card.className = 'meme';

      try {
        const mediaFile = await getFileFromDB(`${meme.id}_media`);
        const mediaURL = createBlobURL(mediaFile);

        let mediaContent = '';
        let indicator = '';

        if (meme.type === 'video') {
          mediaContent = `<video class="meme-content" preload="metadata">
            <source src="${escapeHtmlAttr(mediaURL)}" type="${mediaFile.type}">
          </video>`;
          indicator = `<div class="media-indicator video-indicator">🎥 ВИДЕО</div>`;
        } else {
          mediaContent = `<img class="meme-content" src="${escapeHtmlAttr(mediaURL)}" alt="${escapeHtmlAttr(meme.title)}" loading="lazy">`;
          if (meme.audioId) {
            indicator = `<div class="media-indicator audio-indicator">🔊 ЗВУК</div>`;
          }
        }

        const isLiked = likedMemes[meme.id] || false;
        const likeBtnClass = isLiked ? 'like-btn liked' : 'like-btn';
        const likeBtnDisabled = isLiked ? 'disabled' : '';

        card.innerHTML = `
          ${indicator}
          ${mediaContent}
          <div class="body">
            <h3>${escapeHtml(meme.title)}</h3>
            <div class="like-row">
              <button class="${likeBtnClass}" ${likeBtnDisabled} data-id="${meme.id}" aria-label="Нравится">
                👍 <span class="likes-count">${meme.likes||0}</span>
              </button>
              <button class="like-btn comment-btn" data-id="${meme.id}" aria-label="Комментарии">💬</button>
            </div>
          </div>
        `;

        card.addEventListener('click', function(e) {
          if (!e.target.classList.contains('like-btn') && !e.target.classList.contains('comment-btn')) {
            openMediaModal(meme);
          }
        });

        const likeBtn = card.querySelector('.like-btn:not(.comment-btn)');
        likeBtn.addEventListener('click', function(e){
          e.stopPropagation();
          const foundIdx = memes.findIndex(m => m.id === meme.id);
          if (foundIdx !== -1 && !likedMemes[meme.id]) {
            likeMeme(foundIdx);
          }
        });

        const commentBtn = card.querySelector('.comment-btn');
        commentBtn.addEventListener('click', function(e){
          e.stopPropagation();
          showComments(meme);
        });

        gallery.appendChild(card);
      } catch (error) {
        console.error('Error rendering meme:', error);
      }
    }

    updateStats();
  }

  function likeMeme(i){
    const meme = memes[i];

    if (likedMemes[meme.id]) {
      return; 
    }
    meme.likes = (meme.likes || 0) + 1;
    likedMemes[meme.id] = true; 

    saveToStorage(LS_MEMES, memes);
    saveToStorage(LS_LIKED_MEMES, likedMemes);

    renderMemes();
  }

  function randomQuote(){
    if (!quotes.length) return;
    const q = quotes[Math.floor(Math.random() * quotes.length)];
    quoteBox.textContent = `"${q}"`;
  }

  function randomMeme(){
    if (!memes.length) {
      alert('Пока нет мемов! Добавь первый мем через форму ниже.');
      return;
    }
    const idx = Math.floor(Math.random() * memes.length);

    const nodes = Array.from(gallery.children);
    if (nodes[idx]) {
      nodes[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
      nodes[idx].style.transition = 'box-shadow .3s ease, transform .3s ease';
      nodes[idx].style.boxShadow = '0 30px 60px rgba(0,255,128,0.12)';
      setTimeout(() => { nodes[idx].style.boxShadow = ''; }, 900);
    }
  }

  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  async function addMeme(){
    const titleInput = document.getElementById('memeTitle');
    const typeInput = document.getElementById('memeType');

    const title = (titleInput.value || '').trim();
    const type = typeInput.value;

    if (!title) {
      alert('Введите название мема!');
      return;
    }

    if (!uploadedMedia) {
      alert('Загрузите медиа файл!');
      return;
    }

    progressBar.style.display = 'block';
    progress.style.width = '30%';

    try {
      const memeId = generateId();

      progress.style.width = '60%';
      await saveFileToDB(memeId, uploadedMedia, 'media');

      let audioId = null;
      if (uploadedAudio) {
        progress.style.width = '80%';
        audioId = await saveFileToDB(memeId, uploadedAudio, 'audio');
      }

      progress.style.width = '100%';

      const newMeme = {
        id: memeId,
        title,
        type: uploadedMedia.type.startsWith('video/') ? 'video' : 'image',
        audioId: audioId,
        likes: 0,
        createdAt: Date.now()
      };

      memes.unshift(newMeme);
      saveToStorage(LS_MEMES, memes);

      titleInput.value = '';
      fileInput.value = '';
      uploadedMedia = null;
      uploadedAudio = null;
      fileInfo.textContent = 'Можно загружать картинки, видео и аудио';
      progressBar.style.display = 'none';
      progress.style.width = '0%';

      await renderMemes();
      window.scrollTo({ top: 0, behavior: 'smooth' });

    } catch (error) {
      alert('Ошибка при загрузке файлов: ' + error.message);
      progressBar.style.display = 'none';
      progress.style.width = '0%';
    }
  }

  async function clearLocalData(){
    if (!confirm('Сбросить все мемы, лайки и комментарии?')) return;

    if (db) {
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      store.clear();
    }

    localStorage.removeItem(LS_MEMES);
    localStorage.removeItem(LS_QUOTES);
    localStorage.removeItem(LS_COMMENTS);
    localStorage.removeItem(LS_GAME_STATS);
    localStorage.removeItem(LS_LIKED_MEMES);

    memes = DEFAULT_MEMES.slice();
    quotes = DEFAULT_QUOTES.slice();
    comments = {};
    likedMemes = {};
    gameStats = { score: 0, highScore: 0, correct: 0, total: 0 };

    await renderMemes();
    randomQuote();
    updateGameStats();
  }

  function escapeHtml(str){
    if (!str) return '';
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'", '&#39;');
  }

  function escapeHtmlAttr(str){
    return escapeHtml(str).replaceAll('\n',' ');
  }


  function showComments(meme) {
    currentMemeForComments = meme;
    currentMemeTitle.textContent = meme.title;
    commentsSection.style.display = 'block';
    renderComments();

    commentsSection.scrollIntoView({ behavior: 'smooth' });
  }

  function renderComments() {
    if (!currentMemeForComments) return;

    const memeComments = comments[currentMemeForComments.id] || [];
    commentsContainer.innerHTML = '';

    if (memeComments.length === 0) {
      commentsContainer.innerHTML = `
        <div class="empty-comments">
          <span class="icon">💭</span>
          <div>Пока нет комментариев</div>
          <div style="font-size: 0.9rem; margin-top: 8px; opacity: 0.7;">Оставь первый комментарий!</div>
        </div>
      `;
      return;
    }

    memeComments.sort((a, b) => b.timestamp - a.timestamp);

    memeComments.forEach(comment => {
      const commentEl = document.createElement('div');
      commentEl.className = 'comment';
      commentEl.innerHTML = `
        <div class="comment-header">
          <span class="comment-author">${escapeHtml(comment.author)}</span>
          <span class="comment-date">${new Date(comment.timestamp).toLocaleString()}</span>
        </div>
        <p class="comment-text">${escapeHtml(comment.text)}</p>
      `;
      commentsContainer.appendChild(commentEl);
    });
  }

  function addComment() {
    if (!currentMemeForComments) return;

    const text = commentInput.value.trim();
    if (!text) {
      alert('Введите текст комментария!');
      return;
    }

    const comment = {
      id: generateId(),
      text: text,
      author: 'Анонимный зритель',
      timestamp: Date.now()
    };

    if (!comments[currentMemeForComments.id]) {
      comments[currentMemeForComments.id] = [];
    }

    comments[currentMemeForComments.id].push(comment);
    saveToStorage(LS_COMMENTS, comments);

    commentInput.value = '';

    renderComments();
  }

  function toggleGame() {
    const isVisible = gameSection.style.display !== 'none';
    gameSection.style.display = isVisible ? 'none' : 'block';

    if (!isVisible) {
      updateGameStats();
      gameActive = true;
      gameInput.disabled = false;
      gameInput.value = '';
      gameInput.classList.remove('correct', 'wrong');
      gameResult.innerHTML = '';
      startGameBtn.style.display = 'inline-block';
      nextGameBtn.style.display = 'none';
      checkAnswerBtn.style.display = 'none';
    }
  }

  function updateGameStats() {
    gameScore.textContent = gameStats.score;
    gameHighScore.textContent = gameStats.highScore;
    gameCorrect.textContent = gameStats.correct;
    gameTotal.textContent = gameStats.total;
  }

  async function startGame() {
    if (memes.length === 0) {
      alert('Нужно хотя бы один мем для игры!');
      return;
    }

    gameActive = true;
    startGameBtn.style.display = 'none';
    nextGameBtn.style.display = 'inline-block';
    checkAnswerBtn.style.display = 'inline-block';
    gameInput.disabled = false;
    gameInput.value = '';
    gameInput.classList.remove('correct', 'wrong');
    gameResult.innerHTML = '';

    await nextGameRound();
  }

  async function nextGameRound() {
    if (!gameActive) return;

    currentGameMeme = memes[Math.floor(Math.random() * memes.length)];

    gameMediaContainer.innerHTML = '';
    gameInput.value = '';
    gameInput.classList.remove('correct', 'wrong');
    gameResult.innerHTML = '';
    gameInput.disabled = false;
    gameInput.focus(); 

    try {
      const mediaFile = await getFileFromDB(`${currentGameMeme.id}_media`);
      const mediaURL = createBlobURL(mediaFile);

      if (currentGameMeme.type === 'video') {
        const video = document.createElement('video');
        video.className = 'game-media game-video';
        video.src = mediaURL;
        video.controls = false;
        video.muted = true;
        video.autoplay = true;
        video.loop = true;
        gameMediaContainer.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.className = 'game-media';
        img.src = mediaURL;
        img.alt = 'Угадай мем';
        gameMediaContainer.appendChild(img);
      }

      gameStats.total++;
      updateGameStats();

    } catch (error) {
      console.error('Error loading game media:', error);
      gameResult.innerHTML = '<div class="game-wrong">Ошибка загрузки медиа</div>';
    }
  }

  function checkAnswer() {
    if (!currentGameMeme || !gameActive) return;

    const userAnswer = gameInput.value.trim().toLowerCase();
    const correctAnswer = currentGameMeme.title.toLowerCase();

    if (!userAnswer) {
      alert('Введите название мема!');
      return;
    }

    const isCorrect = userAnswer === correctAnswer;

    if (isCorrect) {
      gameInput.classList.add('correct');
      gameResult.innerHTML = '<div class="game-correct">✅ Верно! +10 очков</div>';
      gameStats.score += 10;
      gameStats.correct++;
    } else {
      gameInput.classList.add('wrong');
      gameResult.innerHTML = `<div class="game-wrong">❌ Неверно! Правильный ответ: "${currentGameMeme.title}"</div>`;
      gameStats.score = Math.max(0, gameStats.score - 5);
    }

    if (gameStats.score > gameStats.highScore) {
      gameStats.highScore = gameStats.score;
    }

    updateGameStats();
    saveToStorage(LS_GAME_STATS, gameStats);
  }

  // События
  randomQuoteBtn.addEventListener('click', randomQuote);
  randomMemeBtn.addEventListener('click', randomMeme);
  statsBtn.addEventListener('click', toggleStats);
  gameBtn.addEventListener('click', toggleGame);
  addMemeBtn.addEventListener('click', addMeme);
  clearStorageBtn.addEventListener('click', clearLocalData);

  addCommentBtn.addEventListener('click', addComment);
  commentInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') addComment();
  });

  startGameBtn.addEventListener('click', startGame);
  nextGameBtn.addEventListener('click', nextGameRound);
  checkAnswerBtn.addEventListener('click', checkAnswer);
  gameInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') checkAnswer();
  });

  closeModal.addEventListener('click', function() {
    mediaModal.style.display = 'none';
    modalVideo.pause();
    modalVideo.src = '';
    revokeBlobURL(modalImage.src);
    modalImage.src = '';
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }
  });

  mediaModal.addEventListener('click', function(e) {
    if (e.target === mediaModal) {
      mediaModal.style.display = 'none';
      modalVideo.pause();
      modalVideo.src = '';
      revokeBlobURL(modalImage.src);
      modalImage.src = '';
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
    }
  });

  document.getElementById('memeTitle').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') addMeme();
  });

  async function init() {
    try {
      await initDB();
      quotes = loadFromStorage(LS_QUOTES) || DEFAULT_QUOTES.slice();
      memes = loadFromStorage(LS_MEMES) || DEFAULT_MEMES.slice();
      comments = loadFromStorage(LS_COMMENTS) || {};
      likedMemes = loadFromStorage(LS_LIKED_MEMES) || {};
      gameStats = loadFromStorage(LS_GAME_STATS) || { score: 0, highScore: 0, correct: 0, total: 0 };

      await renderMemes();
      randomQuote();
      updateGameStats();
    } catch (error) {
      console.error('Initialization error:', error);
      alert('Ошибка инициализации приложения');
    }
  }

  init();
</script>
</body>
</html>
